<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Proxy List</title>
    <style>
      body { margin: 0; font-family: Arial, sans-serif; background: #f9f9f9; color: #333; }
      .sidebar { height: 100%; width: 240px; position: fixed; top: 0; left: 0; background-color: #222;
        padding-top: 20px; transition: 0.3s; overflow-x: hidden; }
      .sidebar.closed { width: 0; padding: 0; }
      .logo { display: flex; justify-content: center; margin-bottom: 20px; }
      .logo img { width: 100px; border-radius: 50%; border: 2px solid #fff; }
      .sidebar h2 { color: #fff; text-align: center; margin-bottom: 20px; font-size: 18px; }
      .sidebar a { padding: 12px 20px; text-decoration: none; font-size: 16px; color: #bbb; display: block; transition: 0.3s; }
      .sidebar a:hover { background-color: #575757; color: #fff; }
      .content { margin-left: 260px; padding: 20px; transition: 0.3s; }
      .collapsed .content { margin-left: 20px; }
      h1 { text-align: center; margin-bottom: 10px; font-size: 28px; color: #222; }
      h2 { margin-top: 30px; color: #444; }
      table { width: 100%; border-collapse: collapse; margin-top: 10px; }
      th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
      th { background: #333; color: #fff; }
      tr:nth-child(even) { background: #f2f2f2; }
      .filter { text-align: center; margin: 20px 0; }
      select { padding: 8px 12px; font-size: 16px; }
      button { padding: 5px 10px; border: none; background: #222; color: #fff; border-radius: 4px; cursor: pointer; }
      button:hover { background: #444; }
      .footer { margin-top: 40px; text-align: center; font-size: 13px; color: #666; }
      .toggle-btn { position: fixed; top: 15px; left: 15px; background: #222; color: #fff; border: none;
        padding: 10px 15px; cursor: pointer; font-size: 16px; border-radius: 4px; z-index: 1000; }
    </style>
  </head>
  <body>
    <button class="toggle-btn" onclick="toggleSidebar()">‚ò∞</button>
    <div class="sidebar" id="sidebar">
      <div class="logo">
        <img src="https://avatars.githubusercontent.com/u/9919?s=200&v=4" alt="Logo"/>
      </div>
      <h2>Navigation</h2>
      <a href="/">üè† Home</a>
      <a href="/sub">üåê Proxy List</a>
      <a href="/tools">üõ†Ô∏è Tools</a>
      <a href="/about">‚ÑπÔ∏è About</a>
    </div>
    <div class="content" id="content">
      <h1>üî• MAZLANA CF üî•</h1>
      <div class="filter">
        <label for="countryFilter">Filter by Country: </label>
        <select id="countryFilter">
          <option value="all">All Countries</option>
        </select>
      </div>
      <div id="proxyContainer"></div>
      <div class="footer">Generated by Cloudflare Worker</div>
    </div>

    <script>
      function toggleSidebar() {
        document.getElementById("sidebar").classList.toggle("closed");
        document.body.classList.toggle("collapsed");
      }

      async function updatePing(prxIP, prxPort, elId) {
        try {
          const res = await fetch(`/check?target=${prxIP}:${prxPort}`);
          const data = await res.json();
          document.getElementById(elId).textContent =
            data.ping || data.status || "OK";
        } catch (e) {
          document.getElementById(elId).textContent = "Fail";
        }
      }

      async function loadProxies() {
        const res = await fetch("/api/v1/sub?format=json");
        const data = await res.json();

        const grouped = {};
        data.forEach((prx) => {
          if (!grouped[prx.country]) grouped[prx.country] = [];
          grouped[prx.country].push(prx);
        });

        // isi dropdown filter
        const select = document.getElementById("countryFilter");
        Object.keys(grouped).forEach((c) => {
          const opt = document.createElement("option");
          opt.value = c;
          opt.textContent = c;
          select.appendChild(opt);
        });

        // render tabel
        const container = document.getElementById("proxyContainer");
        for (const [country, proxies] of Object.entries(grouped)) {
          const div = document.createElement("div");
          div.className = "country-block";
          div.dataset.country = country;
          div.innerHTML = `
            <h2>${country}</h2>
            <table>
              <tr><th>IP</th><th>Port</th><th>ORG</th><th>Ping</th><th>Action</th></tr>
              ${proxies
                .map(
                  (p, i) =>
                    `<tr id="row-${country}-${i}">
                       <td>${p.prxIP}</td>
                       <td>${p.prxPort}</td>
                       <td>${p.org}</td>
                       <td id="ping-${country}-${i}">Loading...</td>
                       <td><button onclick="openProxy('${p.prxIP}','${p.prxPort}','${p.org}')">Open</button></td>
                     </tr>`
                )
                .join("")}
            </table>`;
          container.appendChild(div);

          // cek ping setelah render
          proxies.forEach((p, i) => {
            updatePing(p.prxIP, p.prxPort, `ping-${country}-${i}`);
          });
        }

        // filter by country
        select.addEventListener("change", () => {
          const selected = select.value;
          document.querySelectorAll(".country-block").forEach((block) => {
            block.style.display =
              selected === "all" || block.dataset.country === selected
                ? "block"
                : "none";
          });
        });
      }

      async function openProxy(ip, port, org) {
  const win = window.open("", "_blank");
  win.document.write(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>Proxy Info</title>
      <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f4f4f4; }
        h1 { color: #333; }
        .box {
          background: white; padding: 20px; border-radius: 8px;
          box-shadow: 0 2px 6px rgba(0,0,0,0.2);
          max-width: 400px; margin: auto;
        }
        p { font-size: 16px; }
        .ping { color: green; font-weight: bold; }
      </style>
    </head>
    <body>
      <div class="box">
        <h1>Proxy Info</h1>
        <p><b>IP:</b> ${ip}</p>
        <p><b>Port:</b> ${port}</p>
        <p><b>Organization:</b> ${org}</p>
        <p><b>Ping:</b> <span class="ping" id="ping">Checking...</span></p>
      </div>
      <script>
        async function fetchPing() {
          const start = Date.now();
          try {
            const res = await fetch('/check?target=${ip}:${port}');
            const data = await res.json();
            let ping = data.ping;
            if (!ping) {
              ping = (Date.now() - start) + " ms";
            }
            document.getElementById('ping').textContent = ping;
          } catch(e) {
            document.getElementById('ping').textContent = "Timeout";
          }
        }
        fetchPing();
      <\/script>
    </body>
    </html>
  `);
  win.document.close();
}


      loadProxies();
    </script>
  </body>
</html>
